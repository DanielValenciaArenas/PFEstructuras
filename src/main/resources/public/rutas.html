<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Rutas</title>
    <link rel="stylesheet" href="/public/css/estilos.css">
</head>
<body>

<header class="top">
    <a href="/">← Volver</a>
    <h1>Gestión de Rutas</h1>
</header>

<main class="container">

    <section class="card">
        <h2>Registrar nueva ruta</h2>
        <form id="form-ruta" class="row">
            <input id="origen" placeholder="Origen (nombre exacto)">
            <input id="destino" placeholder="Destino (nombre exacto)">
            <input id="distancia" type="number" step="0.1" min="0.1" placeholder="Distancia (km)">
            <button type="submit">Agregar</button>
        </form>
    </section>

    <section class="card">
        <h2>Rutas registradas</h2>
        <table>
            <thead>
            <tr>
                <th>Origen</th>
                <th>Destino</th>
                <th>Distancia (km)</th>
            </tr>
            </thead>
            <tbody id="tabla-rutas"></tbody>
        </table>
    </section>

    <section class="card">
        <h2>Calcular ruta más corta</h2>
        <form id="form-corta" class="row">
            <input id="origenCorto" placeholder="Origen (nombre exacto)">
            <input id="destinoCorto" placeholder="Destino (nombre exacto)">
            <button type="submit">Calcular</button>
        </form>
        <pre id="resultado" style="margin-top:10px; white-space: pre-line;"></pre>
    </section>

</main>

<script>
    async function cargarRutas() {
      try {
        const res = await fetch('/api/rutas');
        if (!res.ok) return;
        const data = await res.json();
        const tbody = document.getElementById('tabla-rutas');
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;">No hay rutas registradas</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(r => `
          <tr>
            <td>${r.origen}</td>
            <td>${r.destino}</td>
            <td>${r.distancia}</td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Error al cargar rutas:', e);
      }
    }

    document.getElementById('form-ruta').addEventListener('submit', async e => {
      e.preventDefault();
      const origen = document.getElementById('origen').value.trim();
      const destino = document.getElementById('destino').value.trim();
      const distancia = parseFloat(document.getElementById('distancia').value);

      if (!origen || !destino) {
        alert('Debes ingresar origen y destino.');
        return;
      }
      if (isNaN(distancia) || distancia <= 0) {
        alert('La distancia debe ser un número mayor que 0.');
        return;
      }

      const res = await fetch('/api/rutas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ origen, destino, distancia })
      });

      if (res.ok) {
        alert('Ruta agregada correctamente');
        e.target.reset();
        await cargarRutas();
      } else {
        alert('Error al agregar ruta');
      }
    });

    document.getElementById('form-corta').addEventListener('submit', async e => {
      e.preventDefault();
      const origen = document.getElementById('origenCorto').value.trim();
      const destino = document.getElementById('destinoCorto').value.trim();

      if (!origen || !destino) {
        alert('Debes ingresar origen y destino.');
        return;
      }

      const res = await fetch(`/api/rutas/corta?origen=${encodeURIComponent(origen)}&destino=${encodeURIComponent(destino)}`);
      const texto = await res.text();
      document.getElementById('resultado').textContent = texto;
    });

    cargarRutas();
</script>

</body>
</html>
